# Spring Security ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬

### êµ¬í˜„ í™”ë©´

ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜ëª»ì…ë ¥ í•  ë•Œì˜ ì²˜ë¦¬

![Untitled](Spring%20Security%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%91%E1%85%A2%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%200c769208385f4ea0a08ee70ee9395760/Untitled.png)

### **ì ‘ê·¼ ë¡œì§**

1. ë¨¼ì € **SecurityConfig.java** ë¡œ ì„¤ì •í•œ `.formLogin()` ë¥¼ í†µí•´ ë¡œê·¸ì¸ ë¡œì§ ì ‘ê·¼
2. `.failureHandler` ë¥¼ í†µí•´ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì²˜ë¦¬ ì„¤ì •í•˜ëŠ”ë° 
ì´ë•Œ `AuthenticationFailureHandler` ì‚¬ìš©.
3. `AuthenticationFailureHandler` ë¥¼ ìƒì†ë°›ëŠ” ì‚¬ìš©ì ì„¤ì • í´ë˜ìŠ¤ (`CustomAuthFailureHandler`)ë¥¼ 
ë”°ë¡œ ìƒì„±í•˜ê³  ìƒì† ë©”ì„œë“œë¥¼ í†µí•´ DefaultFailureUrl ì™€ Exception / Error /  ErrorMessage ì„¤ì •
4. DefaultFailureUrl ë¥¼ ê¸°ë°˜ìœ¼ë¡œ Controller ë¥¼ í†µí•´ ë¡œê·¸ì¸ ì‹¤íŒ¨ í™”ë©´ ì ‘ê·¼.

---

### user/user-login.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--<head th:replace="~{layout/header :: head}">
</head>-->
<body>
<div th:insert="~{layout/header :: header}"></div>

<div id="posts_list">
    <div class="container col-md-6">
        <form th:action="@{/auth/loginProc}" method="post">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <div class="form-group">
                <label>ì•„ì´ë””</label>
                <input type="text" class="form-control" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>

            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" class="form-control" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”">
            </div>

            <span th:if="${error}">
                <p id="valid" class="alert alert-danger" th:text="${exception}"></p>
            </span>

            <button type="submit" class="form-control btn btn-primary bi bi-lock-fill"> ë¡œê·¸ì¸</button>
        </form>
    </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>
</body>
</html>

```

- `<span th:if="${error}"> 
<p id="valid" class="alert alert-danger" th:text="${exception}"></p>
</span>`
 : íƒ€ì„ë¦¬í”„ ì¡°ê±´ì‹( `th:if` )ìœ¼ë¡œ ì ‘ê·¼í•˜ì—¬ error ê°€ ì¡´ì¬í•˜ë©´ exception ì—ëŸ¬ ë©”ì„¸ì§€ ì¶œë ¥

---

[SecurityConfig.java](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/SecurityConfig%20java%20015f023cec014af9baee26055e10a93b.md)

### CustomAuthFailureHandler.java

ê²Œì‹œê¸€ ê´€ë ¨ í™”ë©´ ì—°ê²° ì»¨íŠ¸ë¡¤ëŸ¬

```java
@Component
@Slf4j
public class CustomAuthFailureHandler extends SimpleUrlAuthenticationFailureHandler {
    private final HttpSession session;

    public CustomAuthFailureHandler(HttpSession session) {
        this.session = session;
    }

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response
            , AuthenticationException exception) throws IOException, ServletException {
        String errorMessage;
        if (exception instanceof BadCredentialsException) {
            errorMessage = "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ ì£¼ì„¸ìš”.";
        } else if (exception instanceof InternalAuthenticationServiceException) {
            errorMessage = "ë‚´ë¶€ì ìœ¼ë¡œ ë°œìƒí•œ ì‹œìŠ¤í…œ ë¬¸ì œë¡œ ì¸í•´ ìš”ì²­ì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.";
        } else if (exception instanceof UsernameNotFoundException) {
            errorMessage = "ê³„ì •ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íšŒì›ê°€ì… ì§„í–‰ í›„ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.";
        } else if (exception instanceof AuthenticationCredentialsNotFoundException) {
            errorMessage = "ì¸ì¦ ìš”ì²­ì´ ê±°ë¶€ ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ í•˜ì„¸ìš”.";
        }else {
            log.error(exception.getMessage());
            errorMessage = "ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ë¡œ ë¡œê·¸ì¸ì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜ í•˜ì„¸ìš”";
        }
        /* í•œê¸€ ìì²´ëŠ” urlì— ë§ë„ë¡ ìë™ìœ¼ë¡œ ì¸ì½”ë”©í•´ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì—, ì§ì ‘ UTF-8 ì¸ì½”ë”© ì²˜ë¦¬ */

        errorMessage = URLEncoder.encode(errorMessage, "UTF-8");

        setDefaultFailureUrl("/auth/login?error=true&exception="+errorMessage);

        super.onAuthenticationFailure(request, response, exception);

        session.invalidate(); // ì„¸ì…˜ ì‚­ì œ

    }
}
```

- `onAuthenticationFailure` 
:ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”© í•˜ì—¬ ì˜ˆì™¸ì²˜ë¦¬ í•˜ê³  í•´ë‹¹í•˜ëŠ” error ë©”ì„¸ì§€ë¥¼ 
ë¡œê·¸ì¸ ì‹¤íŒ¨ url ì— ì„¤ì •ë° ì„¸ì…˜ ì‚­ì œ

<aside>
ğŸ’¡ `URLEncoder.encode(errorMessage, "UTF-8");`
ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ê·¸ëƒ¥ ì¶œë ¥í•˜ë©´ ë¸Œë¼ìš°ì € ì—ì„œëŠ” í•´ë‹¹ URL ì— ë§ê²Œ ìë™ìœ¼ë¡œ ì¸ì½”ë”©ì„ í•´ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì—(í•œê¸€ ê¹¨ì§ í˜„ìƒ ë°œìƒ) â‡’ ë”°ë¡œ ì¸ì½”ë”© ì„¤ì •

</aside>

### **UserController**.java

```java
/**
 * íšŒì› ê´€ë ¨ Controller
 */
@RequiredArgsConstructor
@Controller
@Slf4j
public class UserController {

    /*ë¡œê·¸ì¸ ê´€ë ¨*/
    private final UserService userService;

    private final CustomValidators.EmailValidator EmailValidator;
    private final CustomValidators.NicknameValidator NicknameValidator;
    private final CustomValidators.UsernameValidator UsernameValidator;

    ...

    @GetMapping("/auth/login")
    public String login(@RequestParam(value = "error", required = false) String error,
                        @RequestParam(value = "exception", required = false) String exception,
                        Model model) {
        model.addAttribute("error", error);
        model.addAttribute("exception", exception);
        return "/user/user-login";
    }

   ...
}

```

- `/auth/login` ì£¼ì†Œë¥¼ ë§¤í•‘í•˜ì—¬ í•´ë‹¹í•˜ëŠ” ì—ëŸ¬ì™€ ì˜ˆì™¸ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì™€ Model ì— ë„˜ê²¨ì¤Œ.

---