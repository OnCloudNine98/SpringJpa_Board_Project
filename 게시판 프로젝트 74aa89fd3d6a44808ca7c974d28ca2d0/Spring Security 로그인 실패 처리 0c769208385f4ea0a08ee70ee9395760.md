# Spring Security 로그인 실패 처리

### 구현 화면

아이디/비밀번호를 잘못입력 할 때의 처리

![Untitled](Spring%20Security%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%89%E1%85%B5%E1%86%AF%E1%84%91%E1%85%A2%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%200c769208385f4ea0a08ee70ee9395760/Untitled.png)

### **접근 로직**

1. 먼저 **SecurityConfig.java** 로 설정한 `.formLogin()` 를 통해 로그인 로직 접근
2. `.failureHandler` 를 통해 로그인 실패 처리 설정하는데 
이때 `AuthenticationFailureHandler` 사용.
3. `AuthenticationFailureHandler` 를 상속받는 사용자 설정 클래스 (`CustomAuthFailureHandler`)를 
따로 생성하고 상속 메서드를 통해 DefaultFailureUrl 와 Exception / Error /  ErrorMessage 설정
4. DefaultFailureUrl 를 기반으로 Controller 를 통해 로그인 실패 화면 접근.

---

### user/user-login.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<!--<head th:replace="~{layout/header :: head}">
</head>-->
<body>
<div th:insert="~{layout/header :: header}"></div>

<div id="posts_list">
    <div class="container col-md-6">
        <form th:action="@{/auth/loginProc}" method="post">
            <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
            <div class="form-group">
                <label>아이디</label>
                <input type="text" class="form-control" name="username" placeholder="아이디를 입력해주세요">
            </div>

            <div class="form-group">
                <label>비밀번호</label>
                <input type="password" class="form-control" name="password" placeholder="비밀번호를 입력해주세요">
            </div>

            <span th:if="${error}">
                <p id="valid" class="alert alert-danger" th:text="${exception}"></p>
            </span>

            <button type="submit" class="form-control btn btn-primary bi bi-lock-fill"> 로그인</button>
        </form>
    </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>
</body>
</html>

```

- `<span th:if="${error}"> 
<p id="valid" class="alert alert-danger" th:text="${exception}"></p>
</span>`
 : 타임리프 조건식( `th:if` )으로 접근하여 error 가 존재하면 exception 에러 메세지 출력

---

[SecurityConfig.java](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/SecurityConfig%20java%20015f023cec014af9baee26055e10a93b.md)

### CustomAuthFailureHandler.java

게시글 관련 화면 연결 컨트롤러

```java
@Component
@Slf4j
public class CustomAuthFailureHandler extends SimpleUrlAuthenticationFailureHandler {
    private final HttpSession session;

    public CustomAuthFailureHandler(HttpSession session) {
        this.session = session;
    }

    @Override
    public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response
            , AuthenticationException exception) throws IOException, ServletException {
        String errorMessage;
        if (exception instanceof BadCredentialsException) {
            errorMessage = "아이디 또는 비밀번호가 일치하지 않습니다. 다시 한번 확인해 주세요.";
        } else if (exception instanceof InternalAuthenticationServiceException) {
            errorMessage = "내부적으로 발생한 시스템 문제로 인해 요청을 처리할 수 없습니다.관리자에게 문의하세요.";
        } else if (exception instanceof UsernameNotFoundException) {
            errorMessage = "계정이 존재하지 않습니다. 회원가입 진행 후 로그인 해주세요.";
        } else if (exception instanceof AuthenticationCredentialsNotFoundException) {
            errorMessage = "인증 요청이 거부 되었습니다. 관리자에게 문의 하세요.";
        }else {
            log.error(exception.getMessage());
            errorMessage = "알 수 없는 이유로 로그인에 실패 하였습니다. 관리자에게 문의 하세요";
        }
        /* 한글 자체는 url에 맞도록 자동으로 인코딩해주지 않기 때문에, 직접 UTF-8 인코딩 처리 */

        errorMessage = URLEncoder.encode(errorMessage, "UTF-8");

        setDefaultFailureUrl("/auth/login?error=true&exception="+errorMessage);

        super.onAuthenticationFailure(request, response, exception);

        session.invalidate(); // 세션 삭제

    }
}
```

- `onAuthenticationFailure` 
:메서드를 오버라이딩 하여 예외처리 하고 해당하는 error 메세지를 
로그인 실패 url 에 설정및 세션 삭제

<aside>
💡 `URLEncoder.encode(errorMessage, "UTF-8");`
에러 메세지를 그냥 출력하면 브라우저 에서는 해당 URL 에 맞게 자동으로 인코딩을 해주지 않기 때문에(한글 깨짐 현상 발생) ⇒ 따로 인코딩 설정

</aside>

### **UserController**.java

```java
/**
 * 회원 관련 Controller
 */
@RequiredArgsConstructor
@Controller
@Slf4j
public class UserController {

    /*로그인 관련*/
    private final UserService userService;

    private final CustomValidators.EmailValidator EmailValidator;
    private final CustomValidators.NicknameValidator NicknameValidator;
    private final CustomValidators.UsernameValidator UsernameValidator;

    ...

    @GetMapping("/auth/login")
    public String login(@RequestParam(value = "error", required = false) String error,
                        @RequestParam(value = "exception", required = false) String exception,
                        Model model) {
        model.addAttribute("error", error);
        model.addAttribute("exception", exception);
        return "/user/user-login";
    }

   ...
}

```

- `/auth/login` 주소를 매핑하여 해당하는 에러와 예외를 파라미터로 받아와 Model 에 넘겨줌.

---