# [Comment]댓글 작성 및 조회 관련

### 구현 화면

로그인을 성공 한뒤 게시글을 작성하여 정보와 함께 저장

![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled.png)

![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%201.png)

### **접근 로직**

**댓글 조회**

1. 게시글 상세 페이지(posts/posts-read.html) 의 **템플릿 조각**으로 존재하는 댓글 리스트 페이지(comment/list.html) 에 대하여 
2. 게시글 상세 보기 Controller 에서 model attribute 을 통해 넘겨준 댓글 정보(`”comments"`)에 따라
    
    ![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%202.png)
    
3. 타임리프 `th:each` 를 통해 댓글 리스트를 조회 

**댓글 작성**

1. 게시글 상세 페이지에서 게시글을 작성하고 ‘등록’ 버튼을 누르면
2. Footer 의 `<script src="/js/app.js"></script>` 를 통해 [app.js](JavaScript%20%E1%84%8B%E1%85%AA%20%E1%84%8B%E1%85%B2%E1%84%92%E1%85%AD%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A1%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(app%20js)%20a7aa307c3044477393d4dd2cf4e80303.md) 접근
3. app.js 에서 클릭 이벤트 메서드를 통해 공백 검사후 이동 경로 설정
    
    ![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%203.png)
    
4. 매핑된 주소를 통해 CommentApiController 이 실행 되면 경로 변수로 받아온 id를 이용해 CommentService 의 save 메서드 호출
5. CommentService 는 받아온 게시물 id , 사용자 이름 , CommentDto 를 이용해
CommentRepository 메서드 호출
6. CommentRepository 의 상속 받은 `JpaRepository` 의 메서드를 통해 댓글 등록.

---

### posts/posts-read.html

```html
...
    <!-- Comments -->
    <div th:replace="~{comment/list :: list}"></div>
    <div th:replace="~{comment/form :: form}"></div>
</div>
<div th:replace="~{layout/footer :: footer}"></div>

</html>
```

### comment/list.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:fragment="list">
<!-- Comments -->
<div class="card">
    <div class="card-header bi bi-chat-dots" >
        <span th:if="${comments}" th:text="${comments.size}">
        </span> Comments

    </div>
    <!-- 댓글내용 부분 -->
    <ul class="list-group-flush">
        <li th:each="comment : ${comments}" th:id="'comments-' + ${comment.id}" class="list-group-item">
            <span>
                <span style="font-size: small" th:text="${comment.nickname}"></span>
                <span style="font-size: xx-small" th:text="${comment.createdDate}"></span>
            </span>
            <span th:if="${isWriter}" >
                <a type="button" data-toggle="collapse" th:data-target="'.multi-collapse-' + ${comment.id}"
                   class="bi bi-pencil-square"></a> <!-- 댓글 수정 버튼 -->
                <a type="button" th:onclick="'main.commentDelete(' + ${posts.id} + ',' + ${comment.id} + ',' + ${comment.userId} + ',' + ${sessionId} + ')'"
                   class="bi bi-x-square"></a> <!-- 댓글 삭제 버튼 -->
            </span>

            <!-- 댓글 내용 보기 -->
            <p th:class="'collapse multi-collapse-'+${comment.id}+' show'" th:text="${comment.comment}"></p>

            <!-- 댓글 내용 수정 -->
            <form th:class="'collapse multi-collapse-'+${comment.id}">
                <input type="hidden" th:id="'id'" th:value="${comment.id}">
                <input type="hidden" th:id="'postsId'" th:value="${posts.id}">
                <input type="hidden" th:id="'writerUserId'" th:value="${comment.userId}">
<!--                <input type="hidden" th:id="'sessionUserId'" th:value="${sessionUserId}">-->
                <input type="hidden" th:if="${user}" th:id="'sessionUserId'" th:value="${user.id}">
                <div class="form-group">
                    <textarea class="form-control" th:id="'comment-content'" rows="3" th:text="${comment.comment}"></textarea>
                </div>
                <button type="button" id="btn-comment-update" class="btn btn-outline-primary bi bi-pencil-square"> 수정</button>
            </form>
        </li>
    </ul>
</div>
<br/>
</html>

```

### comment/form.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:fragment="form">
<div class="card">
    <div class="card-header bi bi-chat-right-dots"> Write a Comment</div>
    <!-- 댓글작성 부분 -->
    <form>
        <input type="hidden" th:id="postsId" th:value="${posts.id}">
        <div th:if="${user}" class="card-body">
            <textarea id="comment" class="form-control" rows="4" placeholder="댓글을 입력하세요"></textarea>
        </div>
        <div th:if="${user}" class="card-footer">
            <button type="button" id="btn-comment-save" class="btn btn-outline-primary bi bi-pencil-square"> 등록</button>
        </div>
        <div th:unless="${user}" class="card-body" style="font-size: small">
            <a th:href="@{/auth/login}">로그인</a>을 하시면 댓글을 등록할 수 있습니다.
        </div>
    </form>
</div>
</html>

```

---

### CommentApiController.java

댓글 관련 실제 API 관련 컨트롤러

```java
@RequiredArgsConstructor
@RequestMapping("/api")
@RestController
@Slf4j
public class CommentApiController {
    private final CommentService commentService;

    /* CREATE */
    @PostMapping("/posts/{id}/comments")
    public ResponseEntity<Long> save(@PathVariable("id") Long id, @RequestBody CommentDto.Request dto,
                                     @LoginUser UserDto.Response userSessionDto) {
        return ResponseEntity.ok(commentService.save(id, userSessionDto.getNickname(), dto));
    }

    /* READ */
    @GetMapping("/posts/{id}/comments")
    public List<CommentDto.Response> read(@PathVariable("id") Long id) {
        return commentService.findAll(id);
    }

    ...
}
```

- `save()`
: 게시글 작성 관련 컨틀롤러의 메서드
게시글 ID / CommentDto / UserDto 를 이용해 `commentService`의 `save` 메서드 호출
    
    <aside>
    💡 `CommentDto`는 **Request** , ****`UserDto` 는 **Response** 
    
    [기존 접근](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce.md)과 유사 하게 CommentApiController 가 댓글관련 data를 주로 처리하기 때문에 `CommentDto` 와 관련해서는 Request 클래스로 서버로 data를 전송하는 목적으로 Entity 객체로 변환하고 `UserDto` 와 관련 해서는 서버로 부터 data를 가져오는 목적으로 DTO객체로 변환.
    
    </aside>
    
- `read()`
    - `@LoginUser UserDto.Response user`
    : 세션과 관련하여 생성한 [Annotation](%E1%84%8B%E1%85%A6%E1%86%AB%E1%84%90%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20DTO%20e4796b1ecaac44c5b495db7268744b97.md) 이용
    
    > `@PageableDefault` / `Page` 관해서는 뒤의 [페이징 기능](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%91%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%B5%E1%86%BC%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20aea9acce7bfe4d0ca271e1c244c2870f.md)에서 언급
    > 

---

### CommentService.java

```java
@RequiredArgsConstructor
@Service
public class CommentService {

    private final CommentRepository commentRepository;
    private final UserRepository userRepository;
    private final PostsRepository postsRepository;

    /* CREATE */
    @Transactional
    public Long save(Long id, String nickname, CommentDto.Request dto) {
        User user = userRepository.findByNickname(nickname);
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("댓글 쓰기 실패: 해당 게시글이 존재하지 않습니다." + id));
        dto.setUser(user);
        dto.setPosts(posts);

        Comment comment = dto.toEntity();
        commentRepository.save(comment);

        return comment.getId();
    }

    /* READ */
    @Transactional(readOnly = true)
    public List<CommentDto.Response> findAll(Long id) {
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("해당 게시글이 존재하지 않습니다. id: " + id));
        List<Comment> comments = posts.getComments();
        return comments.stream().map(CommentDto.Response::new).collect(Collectors.toList());
    }

    ...
}

```

- `save`
: CommentApiController 로 부터 받아온 파라미터(사용자/게시글 정보) 를 이용하여 
CommentDto 에 담고 그 dto 를 다시 Comment 객체에 담아 commentRepository 에서 저장
    
    > 이때 commentRepository의 `save()` 는 상속받은 JpaRepository 의 `save()`
    > 
- `findAll`
: 해당 게시글의 존재 유무를 따진 뒤 해당 게시글의 정보를 통해 댓글 정보를 받아오고Stream 을 이용하여 List 형태로 리턴
    - `comments.stream().map(CommentDto.Response::new).collect(Collectors.toList());`
        - `comments.stream()`
        : comments(컬렉션)을 Stream 으로 변환
        - `.map(CommentDto.Response::new)`
        :  Stream 의 각 요소를 `CommentDto.Response` 의 객체들로 새로운 Stream을 생성
        - `collect(Collectors.toList())`
        : Stream 의 요소들을 list로 변환
        
        > 정리하면 메서드의 반환 타입 List<CommentDto.Response>에 맞추는 작업
        > 

---