# [Comment]ëŒ“ê¸€ ì‘ì„± ë° ì¡°íšŒ ê´€ë ¨

### êµ¬í˜„ í™”ë©´

ë¡œê·¸ì¸ì„ ì„±ê³µ í•œë’¤ ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ì—¬ ì •ë³´ì™€ í•¨ê»˜ ì €ì¥

![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled.png)

![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%201.png)

### **ì ‘ê·¼ ë¡œì§**

**ëŒ“ê¸€ ì¡°íšŒ**

1. ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€(posts/posts-read.html) ì˜ **í…œí”Œë¦¿ ì¡°ê°**ìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€(comment/list.html) ì— ëŒ€í•˜ì—¬ 
2. ê²Œì‹œê¸€ ìƒì„¸ ë³´ê¸° Controller ì—ì„œ model attribute ì„ í†µí•´ ë„˜ê²¨ì¤€ ëŒ“ê¸€ ì •ë³´(`â€comments"`)ì— ë”°ë¼
    
    ![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%202.png)
    
3. íƒ€ì„ë¦¬í”„ `th:each` ë¥¼ í†µí•´ ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒ 

**ëŒ“ê¸€ ì‘ì„±**

1. ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ì—ì„œ ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ê³  â€˜ë“±ë¡â€™ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
2. Footer ì˜ `<script src="/js/app.js"></script>` ë¥¼ í†µí•´ [app.js](JavaScript%20%E1%84%8B%E1%85%AA%20%E1%84%8B%E1%85%B2%E1%84%92%E1%85%AD%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A1%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(app%20js)%20a7aa307c3044477393d4dd2cf4e80303.md) ì ‘ê·¼
3. app.js ì—ì„œ í´ë¦­ ì´ë²¤íŠ¸ ë©”ì„œë“œë¥¼ í†µí•´ ê³µë°± ê²€ì‚¬í›„ ì´ë™ ê²½ë¡œ ì„¤ì •
    
    ![Untitled](%5BComment%5D%E1%84%83%E1%85%A2%E1%86%BA%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%8C%E1%85%A1%E1%86%A8%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%8C%E1%85%A9%E1%84%92%E1%85%AC%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20521d5bae537048239ed934e9037cfd4c/Untitled%203.png)
    
4. ë§¤í•‘ëœ ì£¼ì†Œë¥¼ í†µí•´ CommentApiController ì´ ì‹¤í–‰ ë˜ë©´ ê²½ë¡œ ë³€ìˆ˜ë¡œ ë°›ì•„ì˜¨ idë¥¼ ì´ìš©í•´ CommentService ì˜ save ë©”ì„œë“œ í˜¸ì¶œ
5. CommentService ëŠ” ë°›ì•„ì˜¨ ê²Œì‹œë¬¼ id , ì‚¬ìš©ì ì´ë¦„ , CommentDto ë¥¼ ì´ìš©í•´
CommentRepository ë©”ì„œë“œ í˜¸ì¶œ
6. CommentRepository ì˜ ìƒì† ë°›ì€ `JpaRepository` ì˜ ë©”ì„œë“œë¥¼ í†µí•´ ëŒ“ê¸€ ë“±ë¡.

---

### posts/posts-read.html

```html
...
    <!-- Comments -->
    <div th:replace="~{comment/list :: list}"></div>
    <div th:replace="~{comment/form :: form}"></div>
</div>
<div th:replace="~{layout/footer :: footer}"></div>

</html>
```

### comment/list.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:fragment="list">
<!-- Comments -->
<div class="card">
    <div class="card-header bi bi-chat-dots" >
        <span th:if="${comments}" th:text="${comments.size}">
        </span> Comments

    </div>
    <!-- ëŒ“ê¸€ë‚´ìš© ë¶€ë¶„ -->
    <ul class="list-group-flush">
        <li th:each="comment : ${comments}" th:id="'comments-' + ${comment.id}" class="list-group-item">
            <span>
                <span style="font-size: small" th:text="${comment.nickname}"></span>
                <span style="font-size: xx-small" th:text="${comment.createdDate}"></span>
            </span>
            <span th:if="${isWriter}" >
                <a type="button" data-toggle="collapse" th:data-target="'.multi-collapse-' + ${comment.id}"
                   class="bi bi-pencil-square"></a> <!-- ëŒ“ê¸€ ìˆ˜ì • ë²„íŠ¼ -->
                <a type="button" th:onclick="'main.commentDelete(' + ${posts.id} + ',' + ${comment.id} + ',' + ${comment.userId} + ',' + ${sessionId} + ')'"
                   class="bi bi-x-square"></a> <!-- ëŒ“ê¸€ ì‚­ì œ ë²„íŠ¼ -->
            </span>

            <!-- ëŒ“ê¸€ ë‚´ìš© ë³´ê¸° -->
            <p th:class="'collapse multi-collapse-'+${comment.id}+' show'" th:text="${comment.comment}"></p>

            <!-- ëŒ“ê¸€ ë‚´ìš© ìˆ˜ì • -->
            <form th:class="'collapse multi-collapse-'+${comment.id}">
                <input type="hidden" th:id="'id'" th:value="${comment.id}">
                <input type="hidden" th:id="'postsId'" th:value="${posts.id}">
                <input type="hidden" th:id="'writerUserId'" th:value="${comment.userId}">
<!--                <input type="hidden" th:id="'sessionUserId'" th:value="${sessionUserId}">-->
                <input type="hidden" th:if="${user}" th:id="'sessionUserId'" th:value="${user.id}">
                <div class="form-group">
                    <textarea class="form-control" th:id="'comment-content'" rows="3" th:text="${comment.comment}"></textarea>
                </div>
                <button type="button" id="btn-comment-update" class="btn btn-outline-primary bi bi-pencil-square"> ìˆ˜ì •</button>
            </form>
        </li>
    </ul>
</div>
<br/>
</html>

```

### comment/form.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:fragment="form">
<div class="card">
    <div class="card-header bi bi-chat-right-dots"> Write a Comment</div>
    <!-- ëŒ“ê¸€ì‘ì„± ë¶€ë¶„ -->
    <form>
        <input type="hidden" th:id="postsId" th:value="${posts.id}">
        <div th:if="${user}" class="card-body">
            <textarea id="comment" class="form-control" rows="4" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div th:if="${user}" class="card-footer">
            <button type="button" id="btn-comment-save" class="btn btn-outline-primary bi bi-pencil-square"> ë“±ë¡</button>
        </div>
        <div th:unless="${user}" class="card-body" style="font-size: small">
            <a th:href="@{/auth/login}">ë¡œê·¸ì¸</a>ì„ í•˜ì‹œë©´ ëŒ“ê¸€ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </form>
</div>
</html>

```

---

### CommentApiController.java

ëŒ“ê¸€ ê´€ë ¨ ì‹¤ì œ API ê´€ë ¨ ì»¨íŠ¸ë¡¤ëŸ¬

```java
@RequiredArgsConstructor
@RequestMapping("/api")
@RestController
@Slf4j
public class CommentApiController {
    private final CommentService commentService;

    /* CREATE */
    @PostMapping("/posts/{id}/comments")
    public ResponseEntity<Long> save(@PathVariable("id") Long id, @RequestBody CommentDto.Request dto,
                                     @LoginUser UserDto.Response userSessionDto) {
        return ResponseEntity.ok(commentService.save(id, userSessionDto.getNickname(), dto));
    }

    /* READ */
    @GetMapping("/posts/{id}/comments")
    public List<CommentDto.Response> read(@PathVariable("id") Long id) {
        return commentService.findAll(id);
    }

    ...
}
```

- `save()`
: ê²Œì‹œê¸€ ì‘ì„± ê´€ë ¨ ì»¨í‹€ë¡¤ëŸ¬ì˜ ë©”ì„œë“œ
ê²Œì‹œê¸€ ID / CommentDto / UserDto ë¥¼ ì´ìš©í•´ `commentService`ì˜ `save` ë©”ì„œë“œ í˜¸ì¶œ
    
    <aside>
    ğŸ’¡ `CommentDto`ëŠ” **Request** , ****`UserDto` ëŠ” **Response** 
    
    [ê¸°ì¡´ ì ‘ê·¼](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce.md)ê³¼ ìœ ì‚¬ í•˜ê²Œ CommentApiController ê°€ ëŒ“ê¸€ê´€ë ¨ dataë¥¼ ì£¼ë¡œ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— `CommentDto` ì™€ ê´€ë ¨í•´ì„œëŠ” Request í´ë˜ìŠ¤ë¡œ ì„œë²„ë¡œ dataë¥¼ ì „ì†¡í•˜ëŠ” ëª©ì ìœ¼ë¡œ Entity ê°ì²´ë¡œ ë³€í™˜í•˜ê³  `UserDto` ì™€ ê´€ë ¨ í•´ì„œëŠ” ì„œë²„ë¡œ ë¶€í„° dataë¥¼ ê°€ì ¸ì˜¤ëŠ” ëª©ì ìœ¼ë¡œ DTOê°ì²´ë¡œ ë³€í™˜.
    
    </aside>
    
- `read()`
    - `@LoginUser UserDto.Response user`
    : ì„¸ì…˜ê³¼ ê´€ë ¨í•˜ì—¬ ìƒì„±í•œ [Annotation](%E1%84%8B%E1%85%A6%E1%86%AB%E1%84%90%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20DTO%20e4796b1ecaac44c5b495db7268744b97.md) ì´ìš©
    
    > `@PageableDefault` / `Page` ê´€í•´ì„œëŠ” ë’¤ì˜ [í˜ì´ì§• ê¸°ëŠ¥](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%91%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%B5%E1%86%BC%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20aea9acce7bfe4d0ca271e1c244c2870f.md)ì—ì„œ ì–¸ê¸‰
    > 

---

### CommentService.java

```java
@RequiredArgsConstructor
@Service
public class CommentService {

    private final CommentRepository commentRepository;
    private final UserRepository userRepository;
    private final PostsRepository postsRepository;

    /* CREATE */
    @Transactional
    public Long save(Long id, String nickname, CommentDto.Request dto) {
        User user = userRepository.findByNickname(nickname);
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("ëŒ“ê¸€ ì“°ê¸° ì‹¤íŒ¨: í•´ë‹¹ ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." + id));
        dto.setUser(user);
        dto.setPosts(posts);

        Comment comment = dto.toEntity();
        commentRepository.save(comment);

        return comment.getId();
    }

    /* READ */
    @Transactional(readOnly = true)
    public List<CommentDto.Response> findAll(Long id) {
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. id: " + id));
        List<Comment> comments = posts.getComments();
        return comments.stream().map(CommentDto.Response::new).collect(Collectors.toList());
    }

    ...
}

```

- `save`
: CommentApiController ë¡œ ë¶€í„° ë°›ì•„ì˜¨ íŒŒë¼ë¯¸í„°(ì‚¬ìš©ì/ê²Œì‹œê¸€ ì •ë³´) ë¥¼ ì´ìš©í•˜ì—¬ 
CommentDto ì— ë‹´ê³  ê·¸ dto ë¥¼ ë‹¤ì‹œ Comment ê°ì²´ì— ë‹´ì•„ commentRepository ì—ì„œ ì €ì¥
    
    > ì´ë•Œ commentRepositoryì˜ `save()` ëŠ” ìƒì†ë°›ì€ JpaRepository ì˜ `save()`
    > 
- `findAll`
: í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì¡´ì¬ ìœ ë¬´ë¥¼ ë”°ì§„ ë’¤ í•´ë‹¹ ê²Œì‹œê¸€ì˜ ì •ë³´ë¥¼ í†µí•´ ëŒ“ê¸€ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ê³ Stream ì„ ì´ìš©í•˜ì—¬ List í˜•íƒœë¡œ ë¦¬í„´
    - `comments.stream().map(CommentDto.Response::new).collect(Collectors.toList());`
        - `comments.stream()`
        : comments(ì»¬ë ‰ì…˜)ì„ Stream ìœ¼ë¡œ ë³€í™˜
        - `.map(CommentDto.Response::new)`
        :  Stream ì˜ ê° ìš”ì†Œë¥¼ `CommentDto.Response` ì˜ ê°ì²´ë“¤ë¡œ ìƒˆë¡œìš´ Streamì„ ìƒì„±
        - `collect(Collectors.toList())`
        : Stream ì˜ ìš”ì†Œë“¤ì„ listë¡œ ë³€í™˜
        
        > ì •ë¦¬í•˜ë©´ ë©”ì„œë“œì˜ ë°˜í™˜ íƒ€ì… List<CommentDto.Response>ì— ë§ì¶”ëŠ” ì‘ì—…
        > 

---