# [User]ê¸°ì¡´ íšŒì›ì •ë³´ ìˆ˜ì • ê¸°ëŠ¥

### êµ¬í˜„ í™”ë©´

![Untitled](%5BUser%5D%E1%84%80%E1%85%B5%E1%84%8C%E1%85%A9%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%87%E1%85%A9%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%20e1ad5ed6adb441c5b376372bc40187dc/Untitled.png)

íšŒì›ì˜ ì •ë³´(ë‹‰ë„¤ì„ , ë¹„ë°€ë²ˆí˜¸) ë¥¼ ìˆ˜ì •í•˜ëŠ” ê¸°ëŠ¥

### **ì ‘ê·¼ ë¡œì§**

1. ë¡œê·¸ì¸ì„ í•œë’¤ íšŒì›ì •ë³´ ìˆ˜ì • ë²„íŠ¼(í†±ë‹ˆë°”í€´ ë²„íŠ¼) ì„ ëˆ„ë¥´ë©´ `â€™/modify'` ì£¼ì†Œ ì´ë™ 
2. ì£¼ì†Œë¥¼ ë§¤í•‘ í•˜ëŠ” `UserController` ì˜ `modify()` ë©”ì„œë“œë¥¼ í†µí•´ ì²˜ë¦¬ í›„  
íšŒì› ì •ë³´ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™
3. íšŒì› ì •ë³´ ìˆ˜ì • í˜ì´ì§€ì—ì„œ ì™„ë£Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´
4. app.js ì˜ í´ë¦­ ì´ë²¤íŠ¸ë¡œ ìœ íš¨ì„± ì²´í¬
5. ìœ íš¨ì„± ê²€ì‚¬ì˜ ì´ìƒì´ ì—†ìœ¼ë©´ â€˜ìˆ˜ì • í•˜ì‹œê² ìŠµë‹ˆê¹Œ?â€™ í™•ì¸ í›„
ajax ì˜ put í˜•ì‹ìœ¼ë¡œ `"/api/user"` ë¡œ ì´ë™
6. `UserApiController`ì˜ í•´ë‹¹ urlë¡œ ë§¤í•‘ ëœ `modify()` ë©”ì„œë“œì—ì„œ 
UserService ì˜ ë©”ì„œë“œ ì²˜ë¦¬ì™€ ì„¸ì…˜ê´€ë ¨ ì²˜ë¦¬í›„ app.js ë¡œ ë¦¬í„´
7. app.js ì—ì„œ `"/"` ì£¼ì†Œ ì´ë™

---

[BaseTimeEntity ](Date%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20%E1%84%8F%E1%85%A5%E1%86%AF%E1%84%85%E1%85%A5%E1%86%B7%E1%84%8B%E1%85%A6%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%8B%E1%85%A6%E1%86%AB%E1%84%90%E1%85%B5%E1%84%90%E1%85%B5%20e46cebaabe6d465e9e5c6b209e5214e7.md) 

[User.java ](%E1%84%83%E1%85%A9%E1%84%86%E1%85%A6%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(Entity)%204baede46aea54d9e8dd03bfd1914be3e.md) 

[JavaScript ì™€ ìœ íš¨ì„± ê²€ì‚¬ ê´€ë ¨(app.js)](JavaScript%20%E1%84%8B%E1%85%AA%20%E1%84%8B%E1%85%B2%E1%84%92%E1%85%AD%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A1%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(app%20js)%20a7aa307c3044477393d4dd2cf4e80303.md)

---

### user/user-modify.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
<div th:replace="~{layout/header :: header}"></div>

<div id="posts_list">
    <div class="container col-md-4">
        <form>
            <label for="id"></label>
            <input type="hidden" id="id" th:value="${user.id}"/>
            <input type="hidden" id="modifiedDate" th:value="${user.modifiedDate}"/>
            <div class="form-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" th:value="${user.username}" class="form-control" readonly/>
            </div>

            <div class="form-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" class="form-control" placeholder="ìˆ˜ì •í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
            </div>

            <div class="form-group">
                <label for="nickname">ë‹‰ë„¤ì„</label>
                <input type="text" id="nickname" th:value="${user.nickname}" class="form-control" placeholder="ìˆ˜ì •í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
            </div>

            <div class="form-group">
                <label for="email">ì´ë©”ì¼</label>
                <input type="email" id="email" th:value="${user.email}" class="form-control" readonly/>
            </div>
        </form>
        <button id="btn-user-modify" class="btn btn-primary bi bi-check-lg"> ì™„ë£Œ</button>
        <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> ëª©ë¡</a>
    </div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>

</body>
</html>

```

---

### UserController.java

```java

@RequiredArgsConstructor
@Controller
@Slf4j
public class UserController {
		...
		/* íšŒì› ì •ë³´ ìˆ˜ì •*/
    @GetMapping("/modify")
    public String modify(@LoginUser UserDto.Response user, Model model) {
        if (user != null) {
            model.addAttribute("user", user);
        }
        return "/user/user-modify";
    }
}
```

> UserService ì—ì„œ JPAì˜ dirty checking ì„ ì´ìš©í•˜ë‹¤ ë³´ë‹ˆ ë¹„êµì  controller ë¡œì§ì´ ê°„ë‹¨
> 

### UserApiController.java

```java
@RequiredArgsConstructor
@RequestMapping("/api")
@RestController
public class UserApiController {
  private final UserService userService;
  private final AuthenticationManager authenticationManager;

  @PutMapping("/user")
  public ResponseEntity<String> modify(@RequestBody UserDto.Request dto) {
      userService.modify(dto);

      /* ë³€ê²½ëœ ì„¸ì…˜ ë“±ë¡ */
      Authentication authentication = authenticationManager.authenticate(
              new UsernamePasswordAuthenticationToken(dto.getUsername(), dto.getPassword()));
      SecurityContextHolder.getContext().setAuthentication(authentication);

      return new ResponseEntity<>("success", HttpStatus.OK);
  }
}
```

- `modify()`
: ë³€ê²½ëœ ì„¸ì…˜ì„ ë°”ë¡œ ë“±ë¡í•˜ê¸° ìœ„í•´ `UsernamePasswordAuthenticationToken`ì„ ë§Œë“¤ê³  **AuthenticationManager**ë¥¼ í†µí•´ ë“±ë¡. 
â‡’ SecurityContextHolder ì•ˆì˜ Context ë¥¼ ë¶ˆëŸ¬ì™€ ë³€ê²½ ëœ Authenticationì„¤ì •
(ì´ë•Œ **AuthenticationManager** ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ **SecurityConfig** ì—ì„œ ë¹ˆìœ¼ë¡œ ë“±ë¡)

### UserService.java

ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ dataë¥¼ ë³€ê²½í•˜ë©´ ìë™ìœ¼ë¡œ `save()`

```java
@RequiredArgsConstructor
@Service
public class UserService {
    private final UserRepository userRepository;
    private final BCryptPasswordEncoder encoder;
    
    ...

		/* íšŒì› ìˆ˜ì • (dirty checking) */
    @Transactional
    public void modify(UserDto.Request dto) {
        User user = userRepository.findById(dto.toEntity().getId()).orElseThrow(() ->
                new IllegalArgumentException("í•´ë‹¹ íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."));
        String encPassword = encoder.encode(dto.getPassword());
        user.modify(dto.getNickname(), encPassword);
    }
 }
```

- `modify()` 
: Dirty Checking ì„ ì´ìš©í•˜ì—¬ ë°ì´í„°ì˜ ê°’ì´ ë³€ê²½í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ëë‚˜ëŠ” ì‹œì ì— ë³€ê²½ëœ dataë¥¼ ë°˜ì˜
    
    <aside>
    ğŸ’¡ **Dirty Checking?**
    íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ DBì˜ dataë¥¼ ê°€ì ¸ì˜¤ë©´ ë°ì´í„°ëŠ” ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ìœ ì§€ë˜ëŠ” ìƒíƒœê°€ ë˜ê³  ì´ ìƒíƒœì—ì„œ dataë¥¼ ë³€ê²½í•˜ë©´ íŠ¸ëœì­ì…˜ì´ ëë‚˜ëŠ” ì‹œì ì— ë³€ê²½ëœ dataë¥¼ DBì— ë°˜ì˜
    
    </aside>
    
    <aside>
    ğŸ’¡ **ì˜ì†ì„± Context?**
    **ì—”í‹°í‹°(Entity)**ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ìƒí˜¸ì‘ìš©ì„ ì¶”ìƒí™”í•˜ê³ , ì—”í‹°í‹°ì˜ ìƒëª…ì£¼ê¸°ë¥¼ ê´€ë¦¬í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ íŠ¹ì§•
    
    </aside>
    

---