# OAuth 2.0 를 이용한 로그인 기능[구글]

### 구현 화면

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled.png)

## 실제 서비스 등록

1-1 ) 구글 OAuth 서비스를 등록하기 위해 다음 링크를 통해 콘솔로 접속 

[https://console.cloud.google.com/apis](https://console.cloud.google.com/apis)

1-2 ) 콘솔 > 사용 설정된 API 및 서비스 > 상단 중앙의 프로젝트 선택 > 새 프로잭트를 클릭하여
프로젝트 이름을 작성하고 생성.

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%201.png)

프로젝트 이름을 작성하고 만들기 버튼 클릭

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%202.png)

1-3 ) 구글 OAuth 클라이언트를 사용하기 위해 OAuth 동의화면이 먼저 구성
 OAuth 동의화면 > External 선택 후 > 만들기 버튼 클

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%203.png)

1-4 ) 앱 이름과 이메일을 입력 후 저장

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%204.png)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%205.png)

1-5 ) 범위 추가 또는 삭제 > email / profile / openid 선택 후 업데이트 > 
Test users는 패스 >  저장  후 계속(완료)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%206.png)

1-6 ) 사용자 인증 정보 > 사용자 인증 정보 만들기 > OAuth 클라이언트 ID

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%207.png)

1-7 ) 애플리케이션 유형 / 이름 / 승인된 리디렉션 URI 설정 > 만들기
URI 주소 ( [http://localhost:8080/login/oauth2/code/google](http://localhost:8080/login/oauth2/code/google) )

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%208.png)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%209.png)

1-8 )클라이언트 아이디, 클라이언트 비밀번호 획득

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%2010.png)

---

## resources/**application-oauth.properties**

```
# Google
spring.security.oauth2.client.registration.google.client-id=클라이언트id
spring.security.oauth2.client.registration.google.client-secret=클라이언트pw
spring.security.oauth2.client.registration.google.scope=profile,email
```

<aside>
💡 scope 기본값을 profile, email만 입력한 이유 (기존의 email, profile, openid )

openid 를 입력하면 OpenId Provider 로 인식 하게 되고 그렇게 되면 결국 
OpenId Provider 인 서비스와 그렇지 않은 서비스로 나눠서 
OAuth2Service 를 만들어야 돼서 번거로움

</aside>

```
# OAUTH
spring.profiles.include=oauth
```

> [application-XXX.properties](http://application-XXX.properties) 로 만들면 XXX라는 profile이 생성 되어 관리 할 수 있고 해당 정보를 가져오기 위해 [application.properties](http://application.properties) 의 `spring.profiles.include` 에 정보를 입력
> 

---

## 엔티티 관련

### **User.java**

```java
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Getter
@Entity
public class User extends BaseTimeEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false , length = 30 , unique = true)
    private String username; //아이디

    @Column(nullable = false , unique = true)
    private String nickname;

    @Column(length = 100)
    private String password;

    @Column(nullable = false , length = 50 ,unique = true)
    private String email;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    /* 회원정보 수정 */
    public void modify(String nickname, String password) {
        this.nickname = nickname;
        this.password = password;
    }
    /* 소셜로그인시 이미 등록된 회원이라면 수정날짜만 업데이트해줘서
     * 기존 데이터를 보존하도록 예외처리 */
    public User updateModifiedDate() {
        this.onPreUpdate();
        return this;
    }

    public String getRoleValue() {
        return this.role.getValue();
    }

}
```

### **UserRepository.java**

```java
public interface extends JpaRepository<User, Long> {
		/* OAuth */
    Optional<User> findByEmail(String email);
}
```

### **Role.java**

```java
@Getter
@RequiredArgsConstructor
public enum Role {
    USER("ROLE_USER"),
    ADMIN("ROLE_ADMIN"),
    SOCIAL("ROLE_SOCIAL");
    private final String value;

}
```

---

## Security 관련

### **SecurityConfig.java**

```java
@RequiredArgsConstructor
@Configuration
@EnableWebSecurity
// 특정 주소로 접근하면 권한 및 인증을 미리 체크
public class SecurityConfig {
    private final CustomUserDetailsService customUserDetailsService;

    private final AuthenticationFailureHandler customFailureHandler;

    private final CustomOAuth2UserService customOAuth2UserService;

    @Bean
    public BCryptPasswordEncoder encoder() {
        return new BCryptPasswordEncoder();
    }
    /* 시큐리티가 로그인 과정에서 password를 가로챌때 어떤 해쉬로 암호화 했는지 확인 */

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }

    @Bean
    public AuthenticationProvider authenticationProvider(AuthenticationManagerBuilder auth) throws Exception {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(customUserDetailsService);
        provider.setPasswordEncoder(encoder());
        return provider;
//        auth.userDetailsService(customUserDetailsService).passwordEncoder(encoder());
        /*auth.userDetailsService(customUserDetailsService).passwordEncoder(this.encoder());
        return auth.build();*/
    }

    @Bean
    public WebSecurityCustomizer configure() {
        return (web) -> web
                .ignoring()
                .requestMatchers("/css/**", "/js/**", "/img/**");
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .csrf((auth) -> auth
                        .ignoringRequestMatchers("/api/**") /* REST API 사용 예외처리 */
                )
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/auth/**", "/posts/read/**", "/posts/search/**").permitAll()
                        .anyRequest().authenticated()
                )
                .formLogin((auth) -> auth
                        .loginPage("/auth/login")
                        .loginProcessingUrl("/auth/loginProc")
                        .failureHandler(customFailureHandler)
                        .defaultSuccessUrl("/")
                )
                .logout((auth) -> auth
                        .logoutRequestMatcher(new AntPathRequestMatcher("/logout"))
                        .invalidateHttpSession(true)
                        .deleteCookies("JSESSIONID")
                        .logoutSuccessUrl("/")
                )
                .oauth2Login((auth) -> auth
                        .userInfoEndpoint(userinfo -> userinfo
                                .userService(customOAuth2UserService) // 서버에서 사용자 정보를 가져온 상태에서 추가로 진행하고자 하는 기능 명시
                        ) // OAuth2 로그인 성공 후 가져올 설정들
                );
        return http.build();
    }

}

```

### **CustomOAuth2UserService.java**

```java
/**
 * Security UserDetailService == OAuth OAuth2UserService
 */
@Slf4j
@RequiredArgsConstructor
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    private final UserRepository userRepository;
    private final HttpSession session;

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2UserService<OAuth2UserRequest, OAuth2User> delegate = new DefaultOAuth2UserService();
        OAuth2User oAuth2User = delegate.loadUser(userRequest);

        /* OAuth2 서비스 id 구분코드 ( 구글, 카카오, 네이버 ) */
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        log.info("registrationId : " + registrationId);

        /* OAuth2 로그인 진행시 키가 되는 필드 값 (PK) (구글의 기본 코드는 "sub") */
        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails()
                .getUserInfoEndpoint().getUserNameAttributeName();

        log.info("============================================");
        log.info("userNameAttributeName : " + userNameAttributeName);

        /* OAuth2UserService */
        OAuthAttributes attributes = OAuthAttributes.of(registrationId, userNameAttributeName, oAuth2User.getAttributes());
        log.info("=============================================");
        log.info("getAttributes(): " + attributes.getAttributes());

        User user = saveOrUpdate(attributes);

        return new DefaultOAuth2User(
                Collections.singleton(new SimpleGrantedAuthority(user.getRoleValue())),
                attributes.getAttributes(),
                attributes.getNameAttributeKey()
        );

    }

         /* 소셜로그인시 기존 회원이 존재하면 수정날짜 정보만 업데이트해 기존의 데이터는 그대로 보존한다. */
        private User saveOrUpdate(OAuthAttributes attributes) {
            User user = userRepository.findByEmail(attributes.getEmail())
                    .map(User::updateModifiedDate)
                    .orElse(attributes.toEntity());
            return userRepository.save(user);
        }
}

```

### **OAuthAttributes.java**

```java
/**
 * OAuth DTO class
 */
@Slf4j
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Getter
public class OAuthAttributes {
    private Map<String, Object> attributes;
    private String nameAttributeKey;
    private String username;
    private String nickname; 
    private String email;
    private Role role;

    public static OAuthAttributes of(String registrationId, String userNameAttributeName,
                                     Map<String, Object> attributes) {
        /* 구글인지 네이버인지 카카오인지 구분하기 위한 메소드 (ofNaver, ofKaKao) */
        if ("naver".equals(registrationId)) {
            return ofNaver("id", attributes);
        }
        //사실상 if ("google".equals(registrationId)) {
        return ofGoogle(userNameAttributeName, attributes);
    }

    private static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
        return OAuthAttributes.builder()
                .username((String) attributes.get("email"))
                .email((String)attributes.get("email"))
                .nickname((String) attributes.get("name"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    private static OAuthAttributes ofNaver(String userNameAttributeName, Map<String, Object> attributes) {
        /* JSON형태이기 때문에 Map을 통해 데이터를 가져옴. */
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");

        log.info("naver response : " + response);

        return OAuthAttributes.builder()
                .username((String) attributes.get("email"))
                .email((String) attributes.get("email"))
                .nickname((String) attributes.get("name"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    public User toEntity() {
        return User.builder()
                .username(username)
                .email(email)
                .nickname(nickname)
                .role(Role.SOCIAL)
                .build();
    }
}

```

---