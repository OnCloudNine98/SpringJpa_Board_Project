# OAuth 2.0 ë¥¼ ì´ìš©í•œ ë¡œê·¸ì¸ ê¸°ëŠ¥[êµ¬ê¸€]

### êµ¬í˜„ í™”ë©´

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled.png)

## ì‹¤ì œ ì„œë¹„ìŠ¤ ë“±ë¡

1-1 ) êµ¬ê¸€ OAuth ì„œë¹„ìŠ¤ë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•´ ë‹¤ìŒ ë§í¬ë¥¼ í†µí•´ ì½˜ì†”ë¡œ ì ‘ì† 

[https://console.cloud.google.com/apis](https://console.cloud.google.com/apis)

1-2 ) ì½˜ì†” > ì‚¬ìš© ì„¤ì •ëœ API ë° ì„œë¹„ìŠ¤ > ìƒë‹¨ ì¤‘ì•™ì˜ í”„ë¡œì íŠ¸ ì„ íƒ > ìƒˆ í”„ë¡œì­íŠ¸ë¥¼ í´ë¦­í•˜ì—¬
í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì‘ì„±í•˜ê³  ìƒì„±.

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%201.png)

í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì‘ì„±í•˜ê³  ë§Œë“¤ê¸° ë²„íŠ¼ í´ë¦­

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%202.png)

1-3 ) êµ¬ê¸€ OAuth í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ OAuth ë™ì˜í™”ë©´ì´ ë¨¼ì € êµ¬ì„±
 OAuth ë™ì˜í™”ë©´ > External ì„ íƒ í›„ > ë§Œë“¤ê¸° ë²„íŠ¼ í´

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%203.png)

1-4 ) ì•± ì´ë¦„ê³¼ ì´ë©”ì¼ì„ ì…ë ¥ í›„ ì €ì¥

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%204.png)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%205.png)

1-5 ) ë²”ìœ„ ì¶”ê°€ ë˜ëŠ” ì‚­ì œ > email / profile / openid ì„ íƒ í›„ ì—…ë°ì´íŠ¸ > 
Test usersëŠ” íŒ¨ìŠ¤ >  ì €ì¥  í›„ ê³„ì†(ì™„ë£Œ)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%206.png)

1-6 ) ì‚¬ìš©ì ì¸ì¦ ì •ë³´ > ì‚¬ìš©ì ì¸ì¦ ì •ë³´ ë§Œë“¤ê¸° > OAuth í´ë¼ì´ì–¸íŠ¸ ID

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%207.png)

1-7 ) ì• í”Œë¦¬ì¼€ì´ì…˜ ìœ í˜• / ì´ë¦„ / ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI ì„¤ì • > ë§Œë“¤ê¸°
URI ì£¼ì†Œ ( [http://localhost:8080/login/oauth2/code/google](http://localhost:8080/login/oauth2/code/google) )

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%208.png)

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%209.png)

1-8 )í´ë¼ì´ì–¸íŠ¸ ì•„ì´ë””, í´ë¼ì´ì–¸íŠ¸ ë¹„ë°€ë²ˆí˜¸ íšë“

![Untitled](OAuth%202%200%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%5B%E1%84%80%E1%85%AE%E1%84%80%E1%85%B3%E1%86%AF%5D%20739067e99ccf49a5810ce99b53c6f16e/Untitled%2010.png)

---

## resources/**application-oauth.properties**

```
# Google
spring.security.oauth2.client.registration.google.client-id=í´ë¼ì´ì–¸íŠ¸id
spring.security.oauth2.client.registration.google.client-secret=í´ë¼ì´ì–¸íŠ¸pw
spring.security.oauth2.client.registration.google.scope=profile,email
```

<aside>
ğŸ’¡ scope ê¸°ë³¸ê°’ì„ profile, emailë§Œ ì…ë ¥í•œ ì´ìœ  (ê¸°ì¡´ì˜ email, profile, openid )

openid ë¥¼ ì…ë ¥í•˜ë©´ OpenId Provider ë¡œ ì¸ì‹ í•˜ê²Œ ë˜ê³  ê·¸ë ‡ê²Œ ë˜ë©´ ê²°êµ­ 
OpenId Provider ì¸ ì„œë¹„ìŠ¤ì™€ ê·¸ë ‡ì§€ ì•Šì€ ì„œë¹„ìŠ¤ë¡œ ë‚˜ëˆ ì„œ 
OAuth2Service ë¥¼ ë§Œë“¤ì–´ì•¼ ë¼ì„œ ë²ˆê±°ë¡œì›€

</aside>

```
# OAUTH
spring.profiles.include=oauth
```

> [application-XXX.properties](http://application-XXX.properties) ë¡œ ë§Œë“¤ë©´ XXXë¼ëŠ” profileì´ ìƒì„± ë˜ì–´ ê´€ë¦¬ í•  ìˆ˜ ìˆê³  í•´ë‹¹ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ [application.properties](http://application.properties) ì˜ `spring.profiles.include` ì— ì •ë³´ë¥¼ ì…ë ¥
> 

---

## ì—”í‹°í‹° ê´€ë ¨

### **User.java**

```java
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Getter
@Entity
public class User extends BaseTimeEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false , length = 30 , unique = true)
    private String username; //ì•„ì´ë””

    @Column(nullable = false , unique = true)
    private String nickname;

    @Column(length = 100)
    private String password;

    @Column(nullable = false , length = 50 ,unique = true)
    private String email;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private Role role;

    /* íšŒì›ì •ë³´ ìˆ˜ì • */
    public void modify(String nickname, String password) {
        this.nickname = nickname;
        this.password = password;
    }
    /* ì†Œì…œë¡œê·¸ì¸ì‹œ ì´ë¯¸ ë“±ë¡ëœ íšŒì›ì´ë¼ë©´ ìˆ˜ì •ë‚ ì§œë§Œ ì—…ë°ì´íŠ¸í•´ì¤˜ì„œ
     * ê¸°ì¡´ ë°ì´í„°ë¥¼ ë³´ì¡´í•˜ë„ë¡ ì˜ˆì™¸ì²˜ë¦¬ */
    public User updateModifiedDate() {
        this.onPreUpdate();
        return this;
    }

    public String getRoleValue() {
        return this.role.getValue();
    }

}
```

### **UserRepository.java**

```java
public interface extends JpaRepository<User, Long> {
		/* OAuth */
    Optional<User> findByEmail(String email);
}
```

### **Role.java**

```java
@Getter
@RequiredArgsConstructor
public enum Role {
    USER("ROLE_USER"),
    ADMIN("ROLE_ADMIN"),
    SOCIAL("ROLE_SOCIAL");
    private final String value;

}
```

---

## Security ê´€ë ¨

### **SecurityConfig.java**

```java
@RequiredArgsConstructor
@Configuration
@EnableWebSecurity
// íŠ¹ì • ì£¼ì†Œë¡œ ì ‘ê·¼í•˜ë©´ ê¶Œí•œ ë° ì¸ì¦ì„ ë¯¸ë¦¬ ì²´í¬
public class SecurityConfig {
    private final CustomUserDetailsService customUserDetailsService;

    private final AuthenticationFailureHandler customFailureHandler;

    private final CustomOAuth2UserService customOAuth2UserService;

    @Bean
    public BCryptPasswordEncoder encoder() {
        return new BCryptPasswordEncoder();
    }
    /* ì‹œíë¦¬í‹°ê°€ ë¡œê·¸ì¸ ê³¼ì •ì—ì„œ passwordë¥¼ ê°€ë¡œì±Œë•Œ ì–´ë–¤ í•´ì‰¬ë¡œ ì•”í˜¸í™” í–ˆëŠ”ì§€ í™•ì¸ */

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration) throws Exception {
        return authenticationConfiguration.getAuthenticationManager();
    }

    @Bean
    public AuthenticationProvider authenticationProvider(AuthenticationManagerBuilder auth) throws Exception {
        DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
        provider.setUserDetailsService(customUserDetailsService);
        provider.setPasswordEncoder(encoder());
        return provider;
//        auth.userDetailsService(customUserDetailsService).passwordEncoder(encoder());
        /*auth.userDetailsService(customUserDetailsService).passwordEncoder(this.encoder());
        return auth.build();*/
    }

    @Bean
    public WebSecurityCustomizer configure() {
        return (web) -> web
                .ignoring()
                .requestMatchers("/css/**", "/js/**", "/img/**");
    }

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
                .csrf((auth) -> auth
                        .ignoringRequestMatchers("/api/**") /* REST API ì‚¬ìš© ì˜ˆì™¸ì²˜ë¦¬ */
                )
                .authorizeHttpRequests((auth) -> auth
                        .requestMatchers("/", "/auth/**", "/posts/read/**", "/posts/search/**").permitAll()
                        .anyRequest().authenticated()
                )
                .formLogin((auth) -> auth
                        .loginPage("/auth/login")
                        .loginProcessingUrl("/auth/loginProc")
                        .failureHandler(customFailureHandler)
                        .defaultSuccessUrl("/")
                )
                .logout((auth) -> auth
                        .logoutRequestMatcher(new AntPathRequestMatcher("/logout"))
                        .invalidateHttpSession(true)
                        .deleteCookies("JSESSIONID")
                        .logoutSuccessUrl("/")
                )
                .oauth2Login((auth) -> auth
                        .userInfoEndpoint(userinfo -> userinfo
                                .userService(customOAuth2UserService) // ì„œë²„ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¨ ìƒíƒœì—ì„œ ì¶”ê°€ë¡œ ì§„í–‰í•˜ê³ ì í•˜ëŠ” ê¸°ëŠ¥ ëª…ì‹œ
                        ) // OAuth2 ë¡œê·¸ì¸ ì„±ê³µ í›„ ê°€ì ¸ì˜¬ ì„¤ì •ë“¤
                );
        return http.build();
    }

}

```

### **CustomOAuth2UserService.java**

```java
/**
 * Security UserDetailService == OAuth OAuth2UserService
 */
@Slf4j
@RequiredArgsConstructor
@Service
public class CustomOAuth2UserService implements OAuth2UserService<OAuth2UserRequest, OAuth2User> {
    private final UserRepository userRepository;
    private final HttpSession session;

    @Override
    public OAuth2User loadUser(OAuth2UserRequest userRequest) throws OAuth2AuthenticationException {
        OAuth2UserService<OAuth2UserRequest, OAuth2User> delegate = new DefaultOAuth2UserService();
        OAuth2User oAuth2User = delegate.loadUser(userRequest);

        /* OAuth2 ì„œë¹„ìŠ¤ id êµ¬ë¶„ì½”ë“œ ( êµ¬ê¸€, ì¹´ì¹´ì˜¤, ë„¤ì´ë²„ ) */
        String registrationId = userRequest.getClientRegistration().getRegistrationId();
        log.info("registrationId : " + registrationId);

        /* OAuth2 ë¡œê·¸ì¸ ì§„í–‰ì‹œ í‚¤ê°€ ë˜ëŠ” í•„ë“œ ê°’ (PK) (êµ¬ê¸€ì˜ ê¸°ë³¸ ì½”ë“œëŠ” "sub") */
        String userNameAttributeName = userRequest.getClientRegistration().getProviderDetails()
                .getUserInfoEndpoint().getUserNameAttributeName();

        log.info("============================================");
        log.info("userNameAttributeName : " + userNameAttributeName);

        /* OAuth2UserService */
        OAuthAttributes attributes = OAuthAttributes.of(registrationId, userNameAttributeName, oAuth2User.getAttributes());
        log.info("=============================================");
        log.info("getAttributes(): " + attributes.getAttributes());

        User user = saveOrUpdate(attributes);

        return new DefaultOAuth2User(
                Collections.singleton(new SimpleGrantedAuthority(user.getRoleValue())),
                attributes.getAttributes(),
                attributes.getNameAttributeKey()
        );

    }

         /* ì†Œì…œë¡œê·¸ì¸ì‹œ ê¸°ì¡´ íšŒì›ì´ ì¡´ì¬í•˜ë©´ ìˆ˜ì •ë‚ ì§œ ì •ë³´ë§Œ ì—…ë°ì´íŠ¸í•´ ê¸°ì¡´ì˜ ë°ì´í„°ëŠ” ê·¸ëŒ€ë¡œ ë³´ì¡´í•œë‹¤. */
        private User saveOrUpdate(OAuthAttributes attributes) {
            User user = userRepository.findByEmail(attributes.getEmail())
                    .map(User::updateModifiedDate)
                    .orElse(attributes.toEntity());
            return userRepository.save(user);
        }
}

```

### **OAuthAttributes.java**

```java
/**
 * OAuth DTO class
 */
@Slf4j
@AllArgsConstructor
@NoArgsConstructor
@Builder
@Getter
public class OAuthAttributes {
    private Map<String, Object> attributes;
    private String nameAttributeKey;
    private String username;
    private String nickname; 
    private String email;
    private Role role;

    public static OAuthAttributes of(String registrationId, String userNameAttributeName,
                                     Map<String, Object> attributes) {
        /* êµ¬ê¸€ì¸ì§€ ë„¤ì´ë²„ì¸ì§€ ì¹´ì¹´ì˜¤ì¸ì§€ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ë©”ì†Œë“œ (ofNaver, ofKaKao) */
        if ("naver".equals(registrationId)) {
            return ofNaver("id", attributes);
        }
        //ì‚¬ì‹¤ìƒ if ("google".equals(registrationId)) {
        return ofGoogle(userNameAttributeName, attributes);
    }

    private static OAuthAttributes ofGoogle(String userNameAttributeName, Map<String, Object> attributes) {
        return OAuthAttributes.builder()
                .username((String) attributes.get("email"))
                .email((String)attributes.get("email"))
                .nickname((String) attributes.get("name"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    private static OAuthAttributes ofNaver(String userNameAttributeName, Map<String, Object> attributes) {
        /* JSONí˜•íƒœì´ê¸° ë•Œë¬¸ì— Mapì„ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´. */
        Map<String, Object> response = (Map<String, Object>) attributes.get("response");

        log.info("naver response : " + response);

        return OAuthAttributes.builder()
                .username((String) attributes.get("email"))
                .email((String) attributes.get("email"))
                .nickname((String) attributes.get("name"))
                .attributes(attributes)
                .nameAttributeKey(userNameAttributeName)
                .build();
    }

    public User toEntity() {
        return User.builder()
                .username(username)
                .email(email)
                .nickname(nickname)
                .role(Role.SOCIAL)
                .build();
    }
}

```

---