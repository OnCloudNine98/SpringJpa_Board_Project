# [Posts]게시글 수정및 삭제 제한 기능

### 구현 화면

![게시글 목록 화면](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce/Untitled.png)

게시글 목록 화면

![Untitled](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%89%E1%85%A1%E1%86%A8%E1%84%8C%E1%85%A6%20%E1%84%8C%E1%85%A6%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%203d034e6ce38c417996d0a6677fb3006c/Untitled.png)

상세 게시글 화면 ( 본인 게시글 O )

![상세 게시글 화면 ( 본인 게시글 X )](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%89%E1%85%A1%E1%86%A8%E1%84%8C%E1%85%A6%20%E1%84%8C%E1%85%A6%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%203d034e6ce38c417996d0a6677fb3006c/Untitled%201.png)

상세 게시글 화면 ( 본인 게시글 X )

![게시글 수정 페이지](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%89%E1%85%A1%E1%86%A8%E1%84%8C%E1%85%A6%20%E1%84%8C%E1%85%A6%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%203d034e6ce38c417996d0a6677fb3006c/Untitled%202.png)

게시글 수정 페이지

### **접근 로직**

1. 게시글 목록 화면(index.html )에서 
PostsIndexController 를 통해 게시글 클릭으로 상세 페이지(posts-read.html )이동
(이때 컨트롤러 에서 게시글/댓글 관련 본인 확인후 결과에 따라 상세 페이지 변화)
2. 상세 페이지에서 다시 PostsIndexController 를 통해 수정 버튼으로 
수정 페이지 (posts-update.html) 이동
3. 수정 페이지의 정보를 수정한 뒤 완료 버튼을  누르면
Footer 의 <script src="/js/app.js"></script> 를 통해 [app.js](JavaScript%20%E1%84%8B%E1%85%AA%20%E1%84%8B%E1%85%B2%E1%84%92%E1%85%AD%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A1%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(app%20js)%20a7aa307c3044477393d4dd2cf4e80303.md) 접근
(app.js 에는 클릭 이벤트 메서드와 유효성 검사 및 이동주소 설정)
    
    ![Untitled](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%89%E1%85%A1%E1%86%A8%E1%84%8C%E1%85%A6%20%E1%84%8C%E1%85%A6%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%203d034e6ce38c417996d0a6677fb3006c/Untitled%203.png)
    
4. PostsIndexController 를 통해 글 수정

---

### posts/posts-read.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:replace="~{layout/header :: header}"></div>
<br/>
<div id="posts_list" class="col-md-12">
    <form class="card">
        <div class="card-header d-flex justify-content-between">
            <label for="id">번호 : [[${posts.id}]]</label>
            <input type="hidden" id="id" th:value="${posts.id}"> <!-- label 연결 -->
            <label for="content">[[${posts.createDate}]]</label>
        </div>
        <div class="card-header d-flex justify-content-between">
            <label for="content">작성자 :[[${posts.writer}]] </label>
            <label for="content"><i class=" bi bi-eye-fill"> [[${posts.view}]] </i></label>
        </div>
        <div class="card-body">
            <label for="title">제목</label>
            <input type="text" class="form-control" id="title" th:value="${posts.title}" readonly>
            <br/>
            <label for="content">내용</label>
            <textarea rows="5" class="form-control" id="content" readonly th:text="${posts.content}"></textarea>
        </div>
    </form>

    <!-- Buttons -->
    <div th:if="${user}">
        <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> 목록</a>
        <span th:if="${writer}">
            <a th:href="@{/posts/update/{id}(id=${posts.id})}" role="button" class="btn btn-primary bi bi-pencil-square"> 수정</a>
            <button type="button" onclick="" id="btn-delete" class="btn btn-danger bi bi-trash"> 삭제</button>
        </span>
    </div>
    <div th:unless="${user}">
        <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> 목록</a>
    </div>

    <!-- Comments -->
    <div th:replace="~{comment/list :: list}"></div>
    <div th:replace="~{comment/form :: form}"></div>
</div>
<div th:replace="~{layout/footer :: footer}"></div>

</html>
```

### posts/posts-update.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{layout/header :: header}"></div>

<div id="posts_list" class="col-md-12">
    <form class="card">
        <div class="card-header d-flex justify-content-between">
            <label th:for="id">번호 : [[${posts.id}]] </label>
            <input type="hidden" id="id" th:value="${posts.id}"> <!-- label 연결 -->
            <label th:for="createDate">[[${posts.createDate}]]</label>
        </div>
        <div class="card-header d-flex justify-content-between">
            <label th:for="writer">작성자 : [[${posts.writer}]] </label>
            <label th:for="view"><i class=" bi bi-eye-fill"> [[${posts.view}]]</i></label>
        </div>
        <div class="card-body">
            <label th:for="title">제목</label>
            <input type="text" class="form-control" id="title" th:value="${posts.title}">
        </div>

        <div class="card-body">
            <label th:for="content">내용</label>
            <textarea rows="5" class="form-control" id="content" th:text="${posts.content}"></textarea>
        </div>
    </form>

    <!-- 버튼 -->
    <a th:href="@{/posts/read/{id}(id=${posts.id})}" role="button" class="btn btn-info bi bi-arrow-return-left"> 취소</a>
    <button type="button" id="btn-update" class="btn btn-primary bi bi-pencil-square"> 완료</button>
</div>

<!-- 푸터 포함 -->
<div th:replace="~{layout/footer :: footer}"></div>
</html>

```

---

### PostsIndexController.java

게시글 관련 화면 연결 컨트롤러

```java
@Slf4j
@RequiredArgsConstructor
@Controller
public class PostsIndexController {
    private final PostsService postsService;
    
     /* 글 상세보기 */
    @GetMapping("/posts/read/{id}")
    public String read(@PathVariable("id") Long id, @LoginUser UserDto.Response user, Model model) {
        PostsDto.Response dto = postsService.findById(id);
        List<CommentDto.Response> comments = dto.getComments();

        /* 댓글 관련 */
        if (comments != null && !comments.isEmpty()) {
            model.addAttribute("comments", comments);
        }
        /* 사용자 관련 */
        if (user != null) {
            model.addAttribute("user", user);

            /* 게시글 작성자 본인인지 확인 */
            if (dto.getUserId().equals(user.getId())) {
                model.addAttribute("writer", true);
            }

            /* 댓글 작성자 본인인지 확인 */
            if (comments.stream().anyMatch(s -> s.getUserId().equals(user.getId()))) {
                model.addAttribute("isWriter", true);

            }
        }

        postsService.updateView(id); // views ++
        model.addAttribute("posts", dto);

        /* 현재 세션의 Userid 전달 _ 댓글 삭제 */
        model.addAttribute("sessionId", user.getId());
        return "posts/posts-read";
    }
		/*해당 게시물 수정*/

    @GetMapping("/posts/update/{id}")
    public String update(@PathVariable("id") Long id, @LoginUser UserDto.Response user, Model model) {
        PostsDto.Response dto = postsService.findById(id);
        if (user != null) {
            model.addAttribute("user", user);
        }
        model.addAttribute("posts", dto);
        return "posts/posts-update";
    }
    ...
}
```

- `read()`
: 게시글 상세 보기기능에 관한 메서드로 경로 변수로 받은 id를 통해 구한 PostsDto 를 통해 댓글 정보(`Comments`)를 받아온 뒤 **Stream** 을 통해 댓글 작성자 를 비교한뒤 조회수 처리후
사용자와 게시물 정보 를 넣어준뒤 리턴.
    
    > 이때 게시글과 댓글의 작성자가 본인인지를 확인하여 boolean 값을 넘겨주고 본인이 아닐경우 posts-read.html 에서 아에 표시가 되지 않도록 설계
    > 
    > 
    > ![Untitled](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%80%E1%85%B3%E1%86%AF%20%E1%84%89%E1%85%AE%E1%84%8C%E1%85%A5%E1%86%BC%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%89%E1%85%A1%E1%86%A8%E1%84%8C%E1%85%A6%20%E1%84%8C%E1%85%A6%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B5%E1%84%82%E1%85%B3%E1%86%BC%203d034e6ce38c417996d0a6677fb3006c/Untitled%204.png)
    > 

<aside>
💡 **스트림과 람다 표현식
`~.stream().anyMatch()`**
Java Stream API의 기능 중 하나로 스트림 내의 요소 중 하나라도 주어진 조건(predicate)을 만족하는지 확인하는 데 사용한다.

**`(parameters) -> expression`**
Java 8 도입된 익명함수를 정의하는 간결한 방법.

</aside>

- `update()`
경로변수로 받아온 id 값으로 게시글을 찾고 사용자 정보를 게시글 수정 화면에 넘겨줌

### PostsApiController.java

게시글 관련 실제 API 관련 컨트롤러

```java
@RequestMapping("/api")
@RequiredArgsConstructor
@RestController
public class PostsApiController {
    private final PostsService postsService;
    
		...
		
    /* UPDATE */
    @PutMapping("/posts/{id}")
    public ResponseEntity update(@PathVariable("id") Long id, @RequestBody PostsDto.Request dto) {
        postsService.update(id, dto);
        return ResponseEntity.ok(id);
    }

    /* DELETE */
    @DeleteMapping("/posts/{id}")
    public ResponseEntity delete(@PathVariable("id") Long id) {
        postsService.delete(id);
        return ResponseEntity.ok(id);
    }
}
```

---

### PostsService.java

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class PostsService {
    private final PostsRepository postsRepository;
    private final UserRepository userRepository;
    ...

   /* UPDATE (dirty checking 영속성 컨텍스트)
	  * User 객체를 영속화시키고, 영속화된 User 객체를 가져와 데이터를 변경하면
	  * 트랜잭션이 끝날 때 자동으로 DB에 저장
	  */
    @Transactional
    public void update(Long id, PostsDto.Request dto) {
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("해당 게시글이 존재하지 않습니다. id=" + id));
        posts.update(dto.getTitle(), dto.getContent());
    }

    /* DELETE */
    @Transactional
    public void delete(Long id) {
        Posts posts = postsRepository.findById(id).orElseThrow(() ->
                new IllegalArgumentException("해당 게시글이 존재하지 않습니다. id=" + id));
        postsRepository.delete(posts);
    }
    
    ...
 }
```

- `update()`
`@Transactional` 이 붙어 있는 메서드가 호출 되면 트랜잭션이 실행 되며
JPA 의 EntityManager 에 의해 영속성 컨텍스트에서 관리 한다.  이렇게 되면 영속성 컨텍스트 안에 관리 되는 Posts 엔티티의 상태 값이 변경되면 상태 변화를 감지.

---