# [Posts]게시판 글쓰기 관련

### 구현 화면

로그인을 성공 한뒤 게시글을 작성하여 정보와 함께 저장

![게시글 목록 화면](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce/Untitled.png)

게시글 목록 화면

![게시글 작성 화면](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce/Untitled%201.png)

게시글 작성 화면

### **접근 로직**

1. PostsIndexController 를 통해 띄어준 게시글 목록 화면에서 글쓰기 버튼
2. 글쓰기 화면에 PostsIndexController 를 통해 회원 정보 받아오고
3. Footer 의 <script src="/js/app.js"></script> 를 통해 [app.js](JavaScript%20%E1%84%8B%E1%85%AA%20%E1%84%8B%E1%85%B2%E1%84%92%E1%85%AD%E1%84%89%E1%85%A5%E1%86%BC%20%E1%84%80%E1%85%A5%E1%86%B7%E1%84%89%E1%85%A1%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(app%20js)%20a7aa307c3044477393d4dd2cf4e80303.md) 접근
4. app.js 에서 클릭 이벤트 메서드를 통해 유효성 검사와 이동주소 설정
    
    ![Untitled](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%80%E1%85%B3%E1%86%AF%E1%84%8A%E1%85%B3%E1%84%80%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20dfc81b46584243cc99d56502743755ce/Untitled%202.png)
    
5. PostsApiController 를 통해 게시글 작성

---

### posts/index.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:replace="~{layout/header :: header}"></div>

<div id="posts_list">
    <table id="table" class="table table-horizontal">
        <thead id="thead">
        <tr>
            <th>번호</th>
            <th class="col-md-6 text-center">제목</th>
            <th>작성자</th>
            <th>작성일</th>
            <th>조회수</th>
        </tr>
        </thead>
        <tbody id="tbody">
        <tr th:each="post : ${posts}">
            <td th:text="${post.id}"></td>
            <td><a th:href="@{/posts/read/{id}(id=${post.id})}" th:text="${post.title}"></a></td>
            <td th:text="${post.writer}"></td>
            <td th:text="${post.createdDate}"></td>
            <td th:text="${post.view}"></td>
        </tr>
        </tbody>
    </table>
    <div class="text-right">
        <a href="/posts/write" role="button" class="btn btn-primary bi bi-pencil-fill"> 글쓰기</a>
    </div>
    <!-- Page -->
    <div th:replace="~{posts/posts-page :: posts-page}"></div>
</div>

<div th:replace="~{layout/footer :: footer}"></div>
</body>
</html>

```

### posts/posts-write.html

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<div th:replace="~{layout/header :: header}"></div>

<div id="posts_list" class="container col-md-8">
    <form>
        <div class="form-group">
            <label for="title">제목</label>
            <input type="text" class="form-control" id="title" placeholder="제목을 입력하세요">
        </div>
        <input type="hidden" class="form-control" id="writer" th:value="${user.nickname}">
        <div class="form-group">
            <label for="content">내용</label>
            <textarea rows="10" class="form-control" id="content" placeholder="내용을 입력하세요"></textarea>
        </div>
    </form>
    <button type="button" id="btn-save" class="btn btn-primary bi bi-pencil-fill"> 작성</button>
    <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> 목록</a>
</div>

<!-- 푸터 포함 -->
<div th:replace="~{layout/footer :: footer}"></div>
</body>
</html>

```

---

### PostsIndexController.java

게시글 관련 화면 연결 컨트롤러

```java
@Slf4j
@RequiredArgsConstructor
@Controller
public class PostsIndexController {
    private final PostsService postsService;

    @GetMapping("/")
    public String index(Model model, @PageableDefault(sort = "id", direction = Sort.Direction.DESC)
                        Pageable pageable, @LoginUser UserDto.Response user) {
        Page<Posts> list = postsService.pageList(pageable);

        if (user != null) {
            model.addAttribute("user", user);
        }
        model.addAttribute("posts", list);
        model.addAttribute("previous", pageable.previousOrFirst().getPageNumber());
        model.addAttribute("next", pageable.next().getPageNumber());
        model.addAttribute("hasNext", list.hasNext());
        model.addAttribute("hasPrev", list.hasPrevious());

        return "index";
    }

    /* 글 작성 */
    @GetMapping("/posts/write")
    public String write(@LoginUser UserDto.Response user, Model model) {
        if (user != null) {
            model.addAttribute("user", user);
        }
        return "posts/posts-write";
    }
}
```

- `index()` 
: 맨 처음 게시글 목록 정보를 받아와 “/”주소의 창 출력 해주는 역할을 해준다.
    - `@LoginUser UserDto.Response user`
    : 세션과 관련하여 생성한 [Annotation](%E1%84%8B%E1%85%A6%E1%86%AB%E1%84%90%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20DTO%20e4796b1ecaac44c5b495db7268744b97.md) 이용
    
    > `@PageableDefault` / `Page` 관해서는 뒤의 [페이징 기능](%5BPosts%5D%E1%84%80%E1%85%A6%E1%84%89%E1%85%B5%E1%84%91%E1%85%A1%E1%86%AB%20%E1%84%91%E1%85%A6%E1%84%8B%E1%85%B5%E1%84%8C%E1%85%B5%E1%86%BC%20%E1%84%8E%E1%85%A5%E1%84%85%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20aea9acce7bfe4d0ca271e1c244c2870f.md)에서 언급
    > 
    
- `write()` : 게시글 작성 화면에 사용자 정보 출력 역할

### PostsApiController.java

게시글 관련 실제 API 관련 컨트롤러

```java
@RequestMapping("/api")
@RequiredArgsConstructor
@RestController
public class PostsApiController {
    private final PostsService postsService;

    /* CREATE */
    @PostMapping("/posts")
    public ResponseEntity save(@RequestBody PostsDto.Request dto, @LoginUser UserDto.Response user) {
        return ResponseEntity.ok(postsService.save(dto, user.getNickname()));
    }
}
```

- `save()` 
: 게시글과 사용자 정보를 파라미터로 받아와 작성해주는 API역할 해준다.
    - `@RequestBody`
    : 클라이언트가 전송한 HTTP Request 의 body를 자바 객체로 변환해주는 역할
    (HTTP 메시지 바디를 직접 조회하는 기능)
    - `ResponseEntity.ok()`
    : Spring Framework에서 HTTP 응답을 생성할 때 사용되는 메서드로 괄호 안에는
    HTTP 상태 코드 / header / body / .. 등을 포함 할 수 있고 
    괄호에 해당하는 부분을 포함한 HTTP 200 ok 상태 코드를 return한다.

<aside>
💡 `PostsDto`는 **Request** 인 반면 ****`UserDto` 는 **Response** ?

PostsApiController 는 주로 게시글(Posts)에 관련 된 처리 과정이기 때문에 
같은 Posts data와 관련해서는 처리후 서버로 넘겨줘 `PostsDto` 의 **Request접근인 반면**,
****User data는 서버에서 data를 가져와 `UserDto` 기준 **Response** 접근을 한 것으로 추론

</aside>

---

### PostsService.java

이름으로 User객체를 찾아 게시물(Posts) Dto 의 엔티티로 바꿔준뒤 Repository 에서 엔티티 저장

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class PostsService {
    private final PostsRepository postsRepository;
    private final UserRepository userRepository;

    /* CREATE */
    @Transactional
    public Long save(PostsDto.Request dto, String nickname) {
        /* User 정보를 가져와 dto에 담아준다. */
        User user = userRepository.findByNickname(nickname);
        dto.setUser(user);
        log.info("PostsService save() 실행");
        Posts posts = dto.toEntity();
        postsRepository.save(posts);

        return posts.getId();
    }
    ...
 }
```

> 이때 postsRepository 의 `save()` 는 상속받은 JpaRepository 의 `save()`
> 

---