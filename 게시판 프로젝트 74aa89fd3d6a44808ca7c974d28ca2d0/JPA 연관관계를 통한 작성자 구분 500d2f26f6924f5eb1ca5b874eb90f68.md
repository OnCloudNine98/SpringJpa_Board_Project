# JPA 연관관계를 통한 작성자 구분

로그인 정보에 따라서 게시물 상세정보 페이지를 다르게 표현.

### 구현 화면

**게시글과 다른 계정으로 로그인**

![Untitled](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/Untitled%203.png)

**게시글 상세보기는 가능 하지만 글의 수정 삭제는 불가**

![Untitled](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/Untitled%204.png)

**해당 게시글의 계정 로그인**

![Untitled](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/Untitled%205.png)

**게시글의 상세정보 뿐 아니라 수정과 삭제도 가능.**

![Untitled](Spring%20Security%20%E1%84%85%E1%85%B3%E1%86%AF%20%E1%84%8B%E1%85%B5%E1%84%8B%E1%85%AD%E1%86%BC%E1%84%92%E1%85%A1%E1%86%AB%20%E1%84%92%E1%85%AC%E1%84%8B%E1%85%AF%E1%86%AB%E1%84%80%E1%85%A1%E1%84%8B%E1%85%B5%E1%86%B8%20%E1%84%86%E1%85%B5%E1%86%BE%20%E1%84%85%E1%85%A9%E1%84%80%E1%85%B3%E1%84%8B%E1%85%B5%201cb8b41398094b2da5fe7c9f5cc213ad/Untitled%206.png)

### **접근 로직**

- 작성자 본인 여부에 따라 게시글의 수정/삭제가 가능하게 하려면 본인을 식별한 식별 data 필요
⇒ 간단히 생각하면 닉네임이나 id 정보를 떠올릴 수 있지만, 
닉네임은 수정 후 문제가 생길 여지가 있다.
⇒ 따라서 추후에 수정할 일이 없는 id를 식별 정보로 하는 것이 적절하며
이를 위해 사용자(`User`) / 게시글(`Posts`) 간의 **연관관계**를 통해 접근

---

- **[Posts.java ](%E1%84%83%E1%85%A9%E1%84%86%E1%85%A6%E1%84%8B%E1%85%B5%E1%86%AB%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB(Entity)%204baede46aea54d9e8dd03bfd1914be3e.md)**
    
    

[PostsDto.java ](%E1%84%8B%E1%85%A6%E1%86%AB%E1%84%90%E1%85%B5%E1%84%90%E1%85%B5%20%E1%84%80%E1%85%AA%E1%86%AB%E1%84%85%E1%85%A7%E1%86%AB%20DTO%20e4796b1ecaac44c5b495db7268744b97.md)

---

### posts/posts-read.html

```html
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<div th:replace="~{layout/header :: header}"></div>
<br/>
<div id="posts_list" class="col-md-12">
    <form class="card">
        <div class="card-header d-flex justify-content-between">
            <label for="id">번호 : [[${posts.id}]]</label>
            <input type="hidden" id="id" th:value="${posts.id}"> <!-- label 연결 -->
            <label for="content">[[${posts.createDate}]]</label>
        </div>
        <div class="card-header d-flex justify-content-between">
            <label for="content">작성자 :[[${posts.writer}]] </label>
            <label for="content"><i class=" bi bi-eye-fill"> [[${posts.view}]] </i></label>
        </div>
        <div class="card-body">
            <label for="title">제목</label>
            <input type="text" class="form-control" id="title" th:value="${posts.title}" readonly>
            <br/>
            <label for="content">내용</label>
            <textarea rows="5" class="form-control" id="content" readonly th:text="${posts.content}"></textarea>
        </div>
    </form>

    <!-- Buttons -->
    <div th:if="${user}">
        <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> 목록</a>
        <span th:if="${writer}">
            <a th:href="@{/posts/update/{id}(id=${posts.id})}" role="button" class="btn btn-primary bi bi-pencil-square"> 수정</a>
            <button type="button" onclick="" id="btn-delete" class="btn btn-danger bi bi-trash"> 삭제</button>
        </span>
    </div>
    <div th:unless="${user}">
        <a href="/" role="button" class="btn btn-info bi bi-arrow-return-left"> 목록</a>
    </div>

    <!-- Comments -->
    <div th:replace="~{comment/list :: list}"></div>
    <div th:replace="~{comment/form :: form}"></div>
</div>
<div th:replace="~{layout/footer :: footer}"></div>

</html>
```

---

### UserRepository.java

```java
public interface UserRepository extends JpaRepository<User, Long> {
  /* Security */
  Optional<User> findByUsername(String username);

  /* OAuth */
  Optional<User> findByEmail(String email);

  /* user GET */
  User findByNickname(String nickname);

  /* 중복 검사> 중복인 경우 true, 중복되지 않은경우 false 리턴 */

  boolean existsByUsername(String username);

  boolean existsByNickname(String nickname);

  boolean existsByEmail(String email);

}
```

### PostsIndexController.java

```java
@Slf4j
@RequiredArgsConstructor
@Controller
public class PostsIndexController {
  private final PostsService postsService;
  ...
  @GetMapping("/posts/read/{id}")
  public String read(@PathVariable("id") Long id, @LoginUser UserDto.Response user, Model model) {
    PostsDto.Response dto = postsService.findById(id);
    List<CommentDto.Response> comments = dto.getComments();

    /* 댓글 관련 */
    if (comments != null && !comments.isEmpty()) {
        model.addAttribute("comments", comments);
    }
    /* 사용자 관련 */
    if (user != null) {
        model.addAttribute("user", user);

        /* 게시글 작성자 본인인지 확인 */
        if (dto.getUserId().equals(user.getId())) {
            model.addAttribute("writer", true);
        }

        /* 댓글 작성자 본인인지 확인 */
        if (comments.stream().anyMatch(s -> s.getUserId().equals(user.getId()))) {
            model.addAttribute("isWriter", true);

        }
    }

    postsService.updateView(id); // views ++
    model.addAttribute("posts", dto);

    /* 현재 세션의 Userid 전달 _ 댓글 삭제 */
    model.addAttribute("sessionId", user.getId());
    return "posts/posts-read";
  }
}
```

### PostsService.java

```java
@Slf4j
@RequiredArgsConstructor
@Service
public class PostsService {
  private final PostsRepository postsRepository;
  private final UserRepository userRepository;

  /* CREATE */
  @Transactional
  public Long save(PostsDto.Request dto, String nickname) {
      /* User 정보를 가져와 dto에 담아준다. */
      User user = userRepository.findByNickname(nickname);
      dto.setUser(user);
      log.info("PostsService save() 실행");
      Posts posts = dto.toEntity();
      postsRepository.save(posts);

      return posts.getId();
  }
  ...
}
```

- `save()`
    - `dto.setUser(user);`
    : **Posts** 의 외래키 인 **user_id** 에 실제 **user**  의 기본 키 인 **id**를 저장하기 위해 PostsDto 에 user 정보 저장.

---